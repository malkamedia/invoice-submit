function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Invoices');
    if (!sheet) {
      throw new Error('We ran into an issue while generating your invoice PDF. Please contact finops@gendigital.com for assistance.');
    }

    if (data.action === 'validateJobCodes') {
      return validateJobCodes(data);
    }
    
    // Check if this is an AP submission request with PDF
    if (data.action === 'submitToAP') {
      return handleAPSubmission(data, sheet);
    }
    
    // Generate unique ID with multiple strategies for guaranteed uniqueness
    const timestamp = new Date();
    
    const dateStr = `${timestamp.getFullYear()}${(timestamp.getMonth() + 1).toString().padStart(2, '0')}${timestamp.getDate().toString().padStart(2, '0')}`;
    const randomNum = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
    const uuidSuffix = Utilities.getUuid().substring(0, 4).toUpperCase();
    const invoiceId = `INV-${dateStr}-${randomNum}-${uuidSuffix}`;
    
    // Append one row per line item (long format)
    if (data.items && data.items.length > 0) {
      data.items.forEach((item, index) => {
        const row = [
          timestamp.toISOString(), // Form Submission Timestamp in column A
          invoiceId,                // Invoice ID in column B
          `LINE-${invoiceId}-${index + 1}-${Utilities.getUuid().substring(0, 6).toUpperCase()}`, // Invoice Line Item ID in column C
          data.costCenter || '',
          getCostCenterName(data.costCenter), // Helper function to get full name
          data.vendorName || '',
          data.vendorLlc || '',
          data.vendorAddress || '',
          data.vendorCity || '',
          data.vendorEmail || '',
          data.clientName || '',
          data.hiringManager || '',
          data.hiringManagerEmail || '',
          data.invoiceNumber || '',
          data.invoiceDate || '',
          data.payTerms || '',
          data.poNumber || '',
          data.serviceStart || '',
          data.serviceEnd || '',
          data.subtotal || '',
          data.taxRate || '',
          data.grandTotal || '',
          item.serviceItem || '',
          item.jobCode || '',
          item.hours || '',
          item.rate || '',
          item.amount || ''
        ];
        
        sheet.appendRow(row);
      });
    }
    
    // Return success response with the generated unique ID
    return ContentService
      .createTextOutput(JSON.stringify({
        'result': 'success',
        'invoiceId': invoiceId,
        'timestamp': timestamp.toISOString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch(error) {
    return ContentService
      .createTextOutput(JSON.stringify({
        'result': 'error',
        'error': error.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function validateJobCodes(data) {
  try {
    const validationSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('JobValidationData');
    if (!validationSheet) {
      throw new Error('Job validation data not found. Please contact finops@gendigital.com.');
    }
    
    const lastRow = validationSheet.getLastRow();
    const values = lastRow > 0
      ? validationSheet.getRange(1, 1, lastRow, 1).getValues().flat()
      : [];
      
    const validCodes = new Set(
      values
        .map(value => String(value).trim())
        .filter(value => value.length > 0)
    );
    
    const inputCodes = Array.isArray(data.jobCodes) ? data.jobCodes : [];
    const invalidCodes = inputCodes
      .map(value => String(value).trim())
      .filter(value => value.length > 0 && !validCodes.has(value));
    
    const uniqueInvalidCodes = [...new Set(invalidCodes)];
    
    return ContentService
      .createTextOutput(JSON.stringify({
        'result': 'success',
        'invalidJobCodes': uniqueInvalidCodes
      }))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({
        'result': 'error',
        'error': error.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function handleAPSubmission(data, sheet) {
  try {
    if (!sheet) {
      throw new Error('We ran into an issue while generating your invoice PDF. Please contact finops@gendigital.com for assistance.');
    }
    // Generate unique ID and save to spreadsheet (same as regular submission)
    const timestamp = new Date();
    const dateStr = `${timestamp.getFullYear()}${(timestamp.getMonth() + 1).toString().padStart(2, '0')}${timestamp.getDate().toString().padStart(2, '0')}`;
    const randomNum = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
    const uuidSuffix = Utilities.getUuid().substring(0, 4).toUpperCase();
    const invoiceId = `INV-${dateStr}-${randomNum}-${uuidSuffix}`;
    
    if (data.items && data.items.length > 0) {
      data.items.forEach((item, index) => {
        const row = [
          timestamp.toISOString(),
          invoiceId,
          `LINE-${invoiceId}-${index + 1}-${Utilities.getUuid().substring(0, 6).toUpperCase()}`,
          data.costCenter || '',
          getCostCenterName(data.costCenter),
          data.vendorName || '',
          data.vendorLlc || '',
          data.vendorAddress || '',
          data.vendorCity || '',
          data.vendorEmail || '',
          data.clientName || '',
          data.hiringManager || '',
          data.hiringManagerEmail || '',
          data.invoiceNumber || '',
          data.invoiceDate || '',
          data.payTerms || '',
          data.poNumber || '',
          data.serviceStart || '',
          data.serviceEnd || '',
          data.subtotal || '',
          data.taxRate || '',
          data.grandTotal || '',
          item.serviceItem || '',
          item.jobCode || '',
          item.hours || '',
          item.rate || '',
          item.amount || ''
        ];
        
        sheet.appendRow(row);
      });
    }
    
    // Get PDF from base64 data sent from client
    if (!data.pdfBase64) {
      throw new Error('PDF data missing');
    }
    
    // Decode base64 PDF
    const pdfBytes = Utilities.base64Decode(data.pdfBase64);
    const pdfBlob = Utilities.newBlob(pdfBytes, 'application/pdf');
    
    // Send email
    const subject = `${data.vendorName} Invoice Submission: ${data.invoiceNumber}`;
    const emailBody = `Hello AP Team,

Please find attached invoice ${data.invoiceNumber} from ${data.vendorName}.

Invoice Details:
- Invoice Number: ${data.invoiceNumber}
- Invoice Date: ${data.invoiceDate}
- Amount: ${data.grandTotal}
- Payment Terms: ${data.payTerms}
- Service Period: ${data.serviceStart} to ${data.serviceEnd}
- Cost Center: ${getCostCenterName(data.costCenter)}

Thank you,
${data.vendorName}`;
    
    const fileName = `${data.vendorName.replace(/[^a-zA-Z0-9]/g, '_')}_${data.invoiceNumber}_${data.invoiceDate}.pdf`;
    
    MailApp.sendEmail({
      to: 'mike@malkamedia.com',
      subject: subject,
      body: emailBody,
      attachments: [pdfBlob.setName(fileName)],
      cc: data.vendorEmail
    });
    
    return ContentService
      .createTextOutput(JSON.stringify({
        'result': 'success',
        'message': 'Invoice submitted to AP successfully',
        'invoiceId': invoiceId
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch(error) {
    return ContentService
      .createTextOutput(JSON.stringify({
        'result': 'error',
        'error': error.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function getCostCenterName(code) {
  const costCenters = {
    '40677': '40677 - ML Malka Post Production',
    '40382': '40382 - ML Malka Production',
    '40405': '40405 - ML Malka Media Operations',
    '40383': '40383 - ML Malka Project Management',
    '40425': '40425 - ML Malka Animation',
    '40473': '40473 - ML Malka Creative Services',
    '40386': '40386 - ML Malka Account Management'
  };
  return costCenters[code] || code;
}
